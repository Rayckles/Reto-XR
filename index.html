<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR con WebXR</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #ar-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 40px;
            font-size: 20px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        #ar-button:hover {
            background: #357ae8;
        }
        #ar-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 999;
            max-width: 300px;
        }
        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>
<body>
    <div id="info">Cargando recursos...</div>
    <button id="ar-button" disabled>Iniciar AR</button>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script type="module">
        // Importar GLTFLoader
        import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/loaders/GLTFLoader.js';
        
        let scene, camera, renderer, model;
        let xrSession = null;
        let xrRefSpace = null;
        const arButton = document.getElementById('ar-button');
        const info = document.getElementById('info');
        
        // URL de tu modelo en GitHub (ajusta con tu usuario y repositorio)
        const modelURL = 'https://github.com/Rayckles/Reto-XR/raw/refs/heads/main/rumi__fortnite_skin__fortnite_x_kpdh.glb';
        
        function updateInfo(message) {
            info.textContent = message;
        }
        
        function init() {
            // Crear escena
            scene = new THREE.Scene();
            
            // Crear cámara
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            // Crear renderer
            renderer = new THREE.WebGLRenderer({ 
                alpha: true, 
                antialias: true 
            });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);
            
            // Añadir luz ambiental
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            
            // Añadir luz direccional
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
            directionalLight.position.set(0, 5, 5);
            scene.add(directionalLight);
            
            // Cargar modelo
            const loader = new GLTFLoader();
            updateInfo('Cargando modelo 3D...');
            
            loader.load(
                modelURL,
                function(gltf) {
                    model = gltf.scene;
                    
                    // Ajustar escala y posición del modelo
                    model.scale.set(0.5, 0.5, 0.5);
                    model.position.set(0, 0, -1.5);
                    
                    scene.add(model);
                    updateInfo('Modelo cargado. Listo para AR.');
                    checkARSupport();
                },
                function(xhr) {
                    const percent = (xhr.loaded / xhr.total * 100).toFixed(0);
                    updateInfo(`Cargando modelo: ${percent}%`);
                },
                function(error) {
                    updateInfo('Error al cargar el modelo. Verifica la URL.');
                    console.error('Error cargando modelo:', error);
                }
            );
            
            // Manejar redimensionamiento
            window.addEventListener('resize', onWindowResize);
        }
        
        function checkARSupport() {
            if ('xr' in navigator) {
                navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
                    if (supported) {
                        arButton.disabled = false;
                        arButton.textContent = 'Iniciar AR';
                        updateInfo('AR disponible. Pulsa el botón para empezar.');
                    } else {
                        updateInfo('AR no soportado en este dispositivo.');
                        arButton.textContent = 'AR no disponible';
                    }
                });
            } else {
                updateInfo('WebXR no disponible en este navegador.');
                arButton.textContent = 'WebXR no disponible';
            }
        }
        
        arButton.addEventListener('click', async () => {
            if (xrSession === null) {
                try {
                    xrSession = await navigator.xr.requestSession('immersive-ar', {
                        requiredFeatures: ['hit-test', 'dom-overlay'],
                        domOverlay: { root: document.body }
                    });
                    
                    await onSessionStarted();
                } catch (error) {
                    updateInfo('Error al iniciar AR: ' + error.message);
                    console.error('Error:', error);
                }
            } else {
                xrSession.end();
            }
        });
        
        async function onSessionStarted() {
            xrSession.addEventListener('end', onSessionEnded);
            
            await renderer.xr.setSession(xrSession);
            
            xrRefSpace = await xrSession.requestReferenceSpace('local');
            
            arButton.textContent = 'Detener AR';
            info.style.display = 'none';
            
            renderer.setAnimationLoop(render);
        }
        
        function onSessionEnded() {
            xrSession = null;
            arButton.textContent = 'Iniciar AR';
            info.style.display = 'block';
            updateInfo('Sesión AR finalizada.');
            
            renderer.setAnimationLoop(null);
        }
        
        function render(timestamp, frame) {
            if (frame && model) {
                // Rotar el modelo suavemente
                model.rotation.y += 0.01;
            }
            
            renderer.render(scene, camera);
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        // Inicializar cuando cargue la página
        init();
    </script>
</body>
</html>
